#!/bin/bash

# start/stop http stack
ngdev() {
  #phpver="`php -r \"echo str_replace('.', '', substr(phpversion(), 0, 3));\"`"
  if [[ $1 == 'restart' ]]; then
    ngdev stop
    ngdev start
  elif [[ $1 == 'start' ]]; then
    #brew services run redis
    #brew services run exolnet/deprecated/php@7.0
    #brew services run mysql
    brew services run nginx
  elif [[ $1 == 'stop' ]]; then
    brew services stop nginx
    #brew services stop mysql
    #brew services stop exolnet/deprecated/php@7.0
    #brew services stop redis
	elif [[ $1 == 'edit' ]]; then
		sudo vi ${HOMEBREW_PREFIX}/etc/nginx/servers/mediastation.dev
		ngdev restart
  else
		brew services info nginx
		echo ""
		echo "'ngdev start' to run without registering"
		echo "'ngdev stop' to stop"
  fi
}

# Keep two folders in sync
livesync() {
  fswatch -r $1 | xargs -I{} rsync -rm --delete $1 $2
}

# Check port usage
check-port() {
  if [[ -z "$1" ]]; then
    echo "Usage: check-port <port>"
    return 1
  fi
  pid=$(sudo lsof -t -iTCP:$1 -sTCP:LISTEN 2>/dev/null | head -1)
  if [[ -z "$pid" ]]; then
    echo "No process listening on port $1"
    return 1
  fi
  cwd=$(sudo lsof -a -p $pid -d cwd -F n 2>/dev/null | tail -1 | cut -c2-)
  cmd=$(ps -o args= -p $pid)
  echo "PID: $pid"
  echo "DIR: $cwd"
  echo "CMD: $cmd"
}

# Kill process on a given port
kill-port() {
  if [[ -z "$1" ]]; then
    echo "Usage: kill-port <port>"
    return 1
  fi
  pid=$(sudo lsof -t -iTCP:$1 -sTCP:LISTEN)
  if [[ -z "$pid" ]]; then
    echo "No process listening on port $1"
    return 1
  fi
  echo "Killing PID $pid on port $1"
  sudo kill -9 $pid
}

# Find which port(s) a process is listening on
port-of() {
  if [[ -z "$1" ]]; then
    echo "Usage: port-of <process-name>"
    return 1
  fi
  sudo lsof -nP -iTCP -sTCP:LISTEN | tail -n +2 | grep -i "$1" | awk '{gsub(/.*:/, "", $9); print $2, $9}' | while read pid port; do
    cwd=$(sudo lsof -a -p $pid -d cwd -F n 2>/dev/null | tail -1 | cut -c2-)
    cmd=$(ps -o comm= -p $pid)
    printf "%-6s %-40s %s\n" "$port" "$cwd" "$cmd"
  done
}

# PDF
joinpdf() {
	output=$1
	input=${@:2}
	if [[ "$output" == "" ]]; then
		output=joined.pdf
	fi
	if [[ "$input" == "" ]]; then
		input=$(ls *.pdf)
	fi
	/System/Library/Automator/Combine\ PDF\ Pages.action/Contents/Resources/join.py -o "$output" $input
}

# PPT
unppt() {
  if [[ ! -z "$1" ]]; then
    cp "$1" "$1.$(date "+%Y%m%d%H%M").bak"
    rm -rf ./pptxtmp
    unzip -q -d ./pptxtmp "$1"
    code ./pptxtmp
  fi
}
reppt() {
  if [[ ! -z "$1" ]]; then
    cd ./pptxtmp
    zip -f -r ../"$1" *
    cd ..
  fi
}

